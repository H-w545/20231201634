{% extends 'base.html' %}

{% block title %}{{ page_title }} - ç™¾åº¦ç‰™ç§‘ç™¾ç§‘{% endblock %}

{% block content %}
<div class="favorites-content">
    <div class="page-header">
        <h1 class="page-title">{{ page_title }}</h1>
        <p class="page-description">æ‚¨æ”¶è—çš„æ‰€æœ‰ç‰™ç§‘çŸ¥è¯†è¯æ¡</p>
    </div>

    {% if entries %}
    <div class="entries-container">
        <div class="entries-grid">
            {% for entry in entries %}
            <div class="entry-card">
                <a href="{% url 'encyclopedia:entry_detail' entry.slug %}" class="entry-link">
                    {% if entry.main_image %}
                    <div class="entry-image">
                        <img src="{{ entry.main_image.image.url }}" alt="{{ entry.title }}" class="entry-thumbnail">
                    </div>
                    {% endif %}
                    <div class="entry-content">
                        <h3 class="entry-title">{{ entry.title }}</h3>
                        <div class="entry-meta">
                            <span class="category-tag">
                                <a href="{% url 'encyclopedia:entry_list_by_category' entry.category.slug %}">
                                    {{ entry.category.name }}
                                </a>
                            </span>
                            <span class="view-count">æµè§ˆ: {{ entry.view_count }}</span>
                            <span class="comment-count">è¯„è®º: {{ entry.comments.count }}</span>
                            <span class="favorite-count">æ”¶è—: {{ entry.favorited_by.count }}</span>
                        </div>
                        <p class="entry-summary">{{ entry.summary }}</p>
                        <div class="entry-footer">
                            <span class="author">ä½œè€…: {{ entry.author.username }}</span>
                            <span class="update-time">{{ entry.updated_at|date:"Y-m-d" }}</span>
                        </div>
                    </div>
                </a>
                <div class="entry-actions">
                    <button class="btn-favorite active" data-entry-id="{{ entry.id }}">
                        <i class="icon-favorite">&#9733;</i>
                        <span>å·²æ”¶è—</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-favorites">
        <div class="empty-icon">ğŸ“š</div>
        <h3>æš‚æ— æ”¶è—å†…å®¹</h3>
        <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•è¯æ¡ï¼Œæµè§ˆè¯æ¡æ—¶ç‚¹å‡»æ”¶è—æŒ‰é’®å¯ä»¥æ·»åŠ æ”¶è—</p>
        <a href="{% url 'encyclopedia:entry_list' %}" class="btn btn-primary">å»æµè§ˆè¯æ¡</a>
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const favoriteButtons = document.querySelectorAll('.btn-favorite');
        favoriteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const entryId = this.getAttribute('data-entry-id');
                const icon = this.querySelector('.icon-favorite');
                const text = this.querySelector('span');
                
                // å‘é€AJAXè¯·æ±‚
                fetch(`{% url 'encyclopedia:toggle_favorite' 0 %}`.replace('0', entryId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        if (data.is_favorited) {
                            this.classList.add('active');
                            icon.textContent = 'â˜…';
                            text.textContent = 'å·²æ”¶è—';
                        } else {
                            this.classList.remove('active');
                            icon.textContent = 'â˜†';
                            text.textContent = 'æ”¶è—';
                            // ä»æ”¶è—åˆ—è¡¨ä¸­ç§»é™¤è¯¥é¡¹
                            const card = this.closest('.entry-card');
                            if (card) {
                                card.style.opacity = '0';
                                setTimeout(() => {
                                    card.remove();
                                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ”¶è—é¡¹
                                    if (document.querySelectorAll('.entry-card').length === 0) {
                                        location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºç©ºçŠ¶æ€
                                    }
                                }, 300);
                            }
                        }
                        
                        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                        showNotification(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                });
            });
        });
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %}
{% endblock %}