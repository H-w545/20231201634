{% extends 'base.html' %}

{% block title %}{{ entry.title }} - ç™¾åº¦ç‰™ç§‘ç™¾ç§‘{% endblock %}

{% block content %}
<div class="entry-detail-content">
    <!-- è¯æ¡æ ‡é¢˜åŒº -->
    <header class="entry-header">
        <h1 class="entry-title">{{ entry.title }}</h1>
        <div class="entry-meta">
            <div class="meta-info">
                <span class="category-badge">
                    <a href="{% url 'encyclopedia:entry_list_by_category' entry.category.slug %}">
                        {{ entry.category.name }}
                    </a>
                </span>
                {% if entry.author %}
                <span class="author">ä½œè€…ï¼š{{ entry.author.username }}</span>
                {% endif %}
                <span class="publish-date">å‘å¸ƒæ—¶é—´ï¼š{{ entry.created_at|date:"Y-m-d H:i:s" }}</span>
                {% if entry.updated_at != entry.created_at %}
                <span class="update-date">æ›´æ–°æ—¶é—´ï¼š{{ entry.updated_at|date:"Y-m-d H:i:s" }}</span>
                {% endif %}
                <span class="view-count">æµè§ˆæ¬¡æ•°ï¼š{{ entry.view_count }}</span>
            </div>
            <div class="action-buttons">
                {% if user.is_authenticated %}
                {% if user == entry.author or user.is_superuser %}
                <a href="{% url 'encyclopedia:edit_entry' entry.slug %}" class="btn btn-edit">ç¼–è¾‘</a>
                <a href="{% url 'encyclopedia:delete_entry' entry.slug %}" class="btn btn-delete">åˆ é™¤</a>
                {% endif %}
                
                <!-- æ”¶è—æŒ‰é’® -->
                <button class="btn btn-favorite {% if user.is_authenticated and entry in user.favorites.all %}
                active{% endif %}" data-entry-id="{{ entry.id }}">
                    <i class="icon-favorite">{% if user.is_authenticated and entry in user.favorites.all %}
                    â˜…{% else %}â˜†{% endif %}</i>
                    <span>{% if user.is_authenticated and entry in user.favorites.all %}å·²æ”¶è—{% else %}æ”¶è—{% endif %}</span>
                </button>
                {% endif %}
                
                <!-- åˆ†äº«æŒ‰é’® -->
                <button class="btn btn-share" id="shareButton">
                    <i class="icon-share">â†—</i>
                    <span>åˆ†äº«</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- è¯æ¡ä¸»å›¾ -->
    {% if entry.entry_image %}
    <div class="entry-main-image">
        <img src="{{ entry.entry_image.url }}" alt="{{ entry.title }}" class="main-image">
    </div>
    {% endif %}

    <!-- è¯æ¡å†…å®¹åŒº -->
    <div class="entry-body">
        <div class="entry-summary">
            <h3>æ‘˜è¦</h3>
            <p>{{ entry.summary }}</p>
        </div>
        <div class="entry-content">
            {{ entry.content|safe }}
        </div>
    </div>
    
    <!-- ç›¸å…³å›¾ç‰‡å±•ç¤º -->
    {% if images %}
    <section class="entry-images">
        <h3>ç›¸å…³å›¾ç‰‡</h3>
        <div class="images-gallery">
            {% for image in images %}
            <div class="image-item">
                <img src="{{ image.image.url }}" alt="å›¾ç‰‡" class="gallery-image">
                {% if image.caption %}
                <div class="image-caption">{{ image.caption }}</div>
                {% endif %}
                {% if user.is_authenticated %}
                {% if user == entry.author or user.is_superuser %}
                <a href="{% url 'encyclopedia:delete_entry_image' image.id %}" class="delete-image" onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')">åˆ é™¤</a>
                {% endif %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- å›¾ç‰‡ä¸Šä¼ è¡¨å• -->
    {% if user.is_authenticated %}
    {% if user == entry.author or user.is_superuser %}
    <section class="image-upload-section">
        <h3>ä¸Šä¼ å›¾ç‰‡</h3>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ image_form.as_p }}
            <button type="submit" name="image_submit" class="btn btn-upload">ä¸Šä¼ å›¾ç‰‡</button>
        </form>
    </section>
    {% endif %}
    {% endif %}

    <!-- è¯æ¡ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="entry-stats">
        <div class="stat-item">
            <span class="stat-label">æµè§ˆæ¬¡æ•°</span>
            <span class="stat-value">{{ entry.view_count }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">æ”¶è—æ¬¡æ•°</span>
            <span class="stat-value favorite-count">{{ entry.favorited_by.count }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">è¯„è®ºæ•°é‡</span>
            <span class="stat-value">{{ entry.comments.count }}</span>
        </div>
    </div>
    
    <!-- ç›¸å…³è¯æ¡æ¨è -->
    {% if related_entries %}
    <section class="related-entries">
        <h3>ç›¸å…³è¯æ¡</h3>
        <div class="related-list">
            {% for related_entry in related_entries %}
            <a href="{% url 'encyclopedia:entry_detail' related_entry.slug %}" class="related-link">
                <span class="related-title">{{ related_entry.title }}</span>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- è¯„è®ºåŒº -->
    <section class="comments-section">
        <h3>è¯„è®º ({{ entry.comments.count }})</h3>
        
        <!-- è¯„è®ºè¡¨å• -->
        {% if user.is_authenticated %}
        <div class="comment-form">
            <h4>å‘è¡¨è¯„è®º</h4>
            <form method="post">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" name="comment_submit" class="btn btn-submit">æäº¤è¯„è®º</button>
            </form>
        </div>
        {% else %}
        <div class="login-prompt">
            <p>è¯·<a href="{% url 'login' %}">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
        </div>
        {% endif %}
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        {% if entry.comments.count > 0 %}
        <div class="comments-list">
            {% for comment in entry.comments.all %}
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.author.username }}</span>
                    <span class="comment-time">{{ comment.created_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                <div class="comment-content">
                    {{ comment.content }}
                </div>
                {% if user == comment.author or user.is_superuser %}
                <div class="comment-actions">
                    <a href="{% url 'encyclopedia:delete_comment' comment.id %}" class="delete-comment">åˆ é™¤</a>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-comments">
            <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // å¹³æ»‘æ»šåŠ¨åˆ°è¯„è®ºåŒº
        const commentLink = document.querySelector('a[href="#comments"]');
        if (commentLink) {
            commentLink.addEventListener('click', function(e) {
                e.preventDefault();
                const commentsSection = document.querySelector('.comments-section');
                if (commentsSection) {
                    commentsSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
        
        // åˆ é™¤ç¡®è®¤
        const deleteButtons = document.querySelectorAll('.btn-delete, .delete-comment, .delete-image');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    e.preventDefault();
                }
            });
        });
        
        // åˆ†äº«åŠŸèƒ½
        const shareButton = document.getElementById('shareButton');
        if (shareButton) {
            shareButton.addEventListener('click', function() {
                const url = window.location.href;
                const title = document.title;
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Share API
                if (navigator.share) {
                    navigator.share({
                        title: title,
                        text: '{{ entry.title }} - ç™¾åº¦ç‰™ç§‘ç™¾ç§‘',
                        url: url
                    }).catch(error => {
                        console.error('åˆ†äº«å¤±è´¥:', error);
                        fallbackShare(url, title);
                    });
                } else {
                    // ä¸æ”¯æŒWeb Share APIæ—¶ä½¿ç”¨å¤åˆ¶é“¾æ¥çš„æ–¹å¼
                    fallbackShare(url, title);
                }
            });
        }
        
        // é™çº§åˆ†äº«æ–¹æ¡ˆ - å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
        function fallbackShare(url, title) {
            // åˆ›å»ºåˆ†äº«é¢æ¿
            const sharePanel = document.createElement('div');
            sharePanel.className = 'share-panel';
            sharePanel.innerHTML = `
                <div class="share-header">
                    <h4>åˆ†äº«è¯æ¡</h4>
                    <button class="share-close">Ã—</button>
                </div>
                <div class="share-content">
                    <p>è¯·é€‰æ‹©åˆ†äº«æ–¹å¼æˆ–å¤åˆ¶é“¾æ¥</p>
                    <div class="share-links">
                        <div class="share-item">
                            <button class="copy-link-btn" data-url="${url}">å¤åˆ¶é“¾æ¥</button>
                        </div>
                        <div class="share-item">
                            <a href="https://weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}" target="_blank" class="share-weibo">
                                <i class="share-icon">ğŸ”·</i> å¾®åš
                            </a>
                        </div>
                        <div class="share-item">
                            <a href="https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}" target="_blank" class="share-qq">
                                <i class="share-icon">ğŸ’™</i> QQ
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(sharePanel);
            
            // å…³é—­åˆ†äº«é¢æ¿
            sharePanel.querySelector('.share-close').addEventListener('click', function() {
                sharePanel.classList.add('hide');
                setTimeout(() => {
                    sharePanel.remove();
                }, 300);
            });
            
            // å¤åˆ¶é“¾æ¥
            sharePanel.querySelector('.copy-link-btn').addEventListener('click', function() {
                const urlToCopy = this.getAttribute('data-url');
                navigator.clipboard.writeText(urlToCopy).then(() => {
                    this.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        this.textContent = 'å¤åˆ¶é“¾æ¥';
                    }, 2000);
                }).catch(err => {
                    console.error('æ— æ³•å¤åˆ¶æ–‡æœ¬:', err);
                });
            });
            
            // æ˜¾ç¤ºåˆ†äº«é¢æ¿
            setTimeout(() => {
                sharePanel.classList.add('show');
            }, 10);
        }
        
        // æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const favoriteButton = document.querySelector('.btn-favorite');
        if (favoriteButton) {
            favoriteButton.addEventListener('click', function() {
                const entryId = this.getAttribute('data-entry-id');
                const icon = this.querySelector('.icon-favorite');
                const text = this.querySelector('span');
                const favoritesCountElement = document.querySelector('.favorite-count');
                
                // å‘é€AJAXè¯·æ±‚
                fetch(`{% url 'encyclopedia:toggle_favorite' 0 %}`.replace('0', entryId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        if (data.is_favorited) {
                            this.classList.add('active');
                            icon.textContent = 'â˜…';
                            text.textContent = 'å·²æ”¶è—';
                        } else {
                            this.classList.remove('active');
                            icon.textContent = 'â˜†';
                            text.textContent = 'æ”¶è—';
                        }
                        
                        // æ›´æ–°æ”¶è—è®¡æ•°
                        if (favoritesCountElement) {
                            favoritesCountElement.textContent = data.favorites_count;
                        }
                        
                        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                        showNotification(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                });
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %}